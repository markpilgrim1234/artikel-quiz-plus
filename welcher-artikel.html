<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DeutschBuddy ‚Äî Welcher Artikel? (der/die/das)</title>
  <meta name="description" content="Quick 1‚Äì3 minute German article quiz. Tap der/die/das, get instant feedback, track streaks and progress ‚Äî no account needed." />

  <!-- Social preview -->
  <meta property="og:title" content="DeutschBuddy ‚Äî Welcher Artikel?" />
  <meta property="og:description" content="Quick German article quiz: der/die/das. Instant feedback + streaks. Snackable 1‚Äì3 minute sessions." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="icon.png" />
  <meta name="twitter:card" content="summary" />

  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />
  <link rel="icon" type="image/png" href="icon.png" />
  <meta name="theme-color" content="#ffffff" />

  <style>
    :root{
      --der: #000000;
      --die: #e94e3c;
      --das: #f4c542;

      --bg: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --card: #ffffff;
      --border: #e5e7eb;
      --shadow: 0 10px 25px rgba(0,0,0,0.06);
      --radius: 14px;

      --primary: #169BD7;
      --primaryHover: #1287BC;

      --start: #16a34a;
      --startHover: #15803d;

      --resetBg: #f3f4f6;
      --resetHover: #e5e7eb;

      --ok: #0f766e;
      --bad: #b91c1c;

      --focus: rgba(22,155,215,0.35);

      --a1plusBg: #2563eb;
      --a1plusText: #ffffff;
    }

    *{ box-sizing: border-box; }
    body{
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.55;
      overflow-x: hidden;
    }
    a{ color: inherit; }

    header{
      position: sticky;
      top: 0;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
      z-index: 20;
    }

    .topbar{
      max-width: 1100px;
      margin: 0 auto;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .brand a{
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
      text-decoration: none;
      color: inherit;
    }

    .brand img{
      width: 34px;
      height: 34px;
      border-radius: 10px;
    }

    .titles{
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .titles h1{
      margin: 0;
      font-size: 1.05rem;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .titles p{
      margin: 0;
      color: var(--muted);
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .btn{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      text-decoration: none;
      font-weight: 800;
      cursor: pointer;
      transition: transform .05s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
      box-shadow: 0 2px 10px rgba(0,0,0,0.04);
      white-space: nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btn:hover{
      border-color: #d1d5db;
      background: #fafafa;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }
    .btn:focus-visible{
      outline: 3px solid var(--focus);
      outline-offset: 2px;
    }

    .btnPrimary{
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
      box-shadow: 0 6px 18px rgba(22,155,215,0.25);
    }
    .btnPrimary:hover{
      background: var(--primaryHover);
      border-color: var(--primaryHover);
    }

    .btnStart{
      background: var(--start);
      border-color: var(--start);
      color: #fff;
      box-shadow: 0 6px 18px rgba(22,163,74,0.22);
    }
    .btnStart:hover{
      background: var(--startHover);
      border-color: var(--startHover);
    }

    .btnSmall{
      padding: 7px 10px;
      font-size: 0.9rem;
      border-radius: 999px;
      box-shadow: none;
    }

    .btnResetSmall{
      background: var(--resetBg);
      border-color: var(--border);
      color: #374151;
    }
    .btnResetSmall:hover{
      background: var(--resetHover);
      border-color: #d1d5db;
      box-shadow: none;
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 16px 28px;
    }

    .grid{
      display: grid;
      gap: 14px;
    }
    @media (min-width: 980px){
      .grid{
        grid-template-columns: 1.25fr 0.9fr;
        align-items: start;
      }
    }

    .hero{
      margin: 18px 0 14px;
      padding: 18px 18px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(180deg, #ffffff 0%, #fafafa 100%);
      box-shadow: var(--shadow);
    }

    .heroTitleRow{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .heroTitle{
      margin: 0;
      font-size: 1.35rem;
      letter-spacing: 0.2px;
      font-weight: 900;
    }

    .heroActions{
      display: inline-flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .iconBtn{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      font-weight: 900;
      box-shadow: 0 2px 10px rgba(0,0,0,0.04);
      white-space: nowrap;
    }
    .iconBtn:hover{
      border-color: #d1d5db;
      background: #fafafa;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }
    .iconBtn:focus-visible{
      outline: 3px solid var(--focus);
      outline-offset: 2px;
    }

    .heroSub{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 1rem;
    }
    .heroSub span[lang="de"]{ font-weight: 900; }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .cardHead{
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }

    .cardHeadLeft{
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .cardHeadLeft .title{
      margin: 0;
      font-size: 1.05rem;
      font-weight: 900;
      color: var(--text);
    }

    .cardHeadLeft .subtitle{
      margin: 0;
      font-size: 0.95rem;
      color: var(--muted);
    }

    .hud{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-end;
    }

    .pill{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      font-weight: 900;
      font-size: 0.95rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.04);
      white-space: nowrap;
    }
    .pill span{ color: var(--muted); font-weight: 800; }

    .content{ padding: 16px; }

    .setup{ display: grid; gap: 12px; }

    .banner{
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid #fde68a;
      background: #fffbeb;
      color: #92400e;
      font-weight: 900;
    }
    .banner small{
      display: block;
      margin-top: 6px;
      font-weight: 800;
      color: rgba(146,64,14,0.85);
    }

    .levelRow{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .levelLabel{ font-weight: 900; color: var(--text); }

    .levelBtn{
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 900;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.04);
      transition: transform .05s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
      user-select: none;
    }
    .levelBtn:hover{
      border-color: #d1d5db;
      background: #fafafa;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }
    .levelBtn:active{ transform: translateY(1px); }
    .levelBtn[aria-pressed="true"]{
      border-color: rgba(22,155,215,0.55);
      box-shadow: 0 8px 22px rgba(22,155,215,0.18);
    }
    .levelBtn:focus-visible{
      outline: 3px solid var(--focus);
      outline-offset: 2px;
    }

    .plusTag{
      margin-left: 6px;
      font-size: 0.75rem;
      font-weight: 900;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #dbeafe;
      background: #eff6ff;
      color: #1d4ed8;
    }

    .includeTag{
      margin-left: 6px;
      font-size: 0.75rem;
      font-weight: 900;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.35);
      background: var(--a1plusBg);
      color: var(--a1plusText);
    }

    .miniNote{ color: var(--muted); font-size: 0.95rem; }

    .word{
      font-size: 2.2rem;
      text-align: center;
      font-weight: 900;
      margin: 10px 0 10px;
      letter-spacing: 0.2px;
    }

    .metaLine{
      text-align: center;
      color: var(--muted);
      font-weight: 800;
      margin: 0 0 12px;
    }

    .options{
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 6px;
    }

    .options button{
      flex: 1;
      padding: 1.1rem;
      font-size: 1.5rem;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      color: #fff;
      font-weight: 900;
      box-shadow: 0 10px 18px rgba(0,0,0,0.08);
      transition: transform .05s ease, filter .2s ease, opacity .2s ease;
    }
    .options button:active{ transform: translateY(1px); }
    .options button:hover{ filter: brightness(0.98); }
    .options button:focus-visible{
      outline: 3px solid var(--focus);
      outline-offset: 2px;
    }
    .options button[data-article="der"]{ background: var(--der); }
    .options button[data-article="die"]{ background: var(--die); }
    .options button[data-article="das"]{ background: var(--das); color: #111; }
    .options button:disabled{
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }

    .result{
      margin-top: 14px;
      font-weight: 900;
      text-align: center;
      font-size: 1.25rem;
      min-height: 1.6em;
    }

    .extra{
      margin-top: 10px;
      padding: 12px;
      border-radius: 12px;
      border: 1px dashed #d1d5db;
      background: #fbfbfb;
      text-align: center;
      color: #374151;
      font-size: 1.05rem;
      min-height: 1.2em;
    }

    .countdownRow{
      margin-top: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      min-height: 40px;
      flex-wrap: wrap;
    }
    #countdown{
      font-weight: 900;
      color: var(--muted);
      font-size: 0.95rem;
      text-align: center;
      white-space: nowrap;
    }

    details.answersDetails{ border-top: 1px solid var(--border); }
    details.answersDetails > summary{
      cursor: pointer;
      list-style: none;
      padding: 14px 16px;
      font-weight: 900;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    details.answersDetails > summary::-webkit-details-marker{ display:none; }
    .historyWrap{
      max-height: 520px;
      overflow: auto;
      padding: 0 16px 16px;
    }
    table{
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }
    th, td{
      padding: 10px 8px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }
    th{
      text-align: left;
      color: #374151;
      font-weight: 900;
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 2;
    }
    td.status{
      width: 56px;
      text-align: center;
      font-weight: 900;
      white-space: nowrap;
    }
    .ok{ color: var(--ok); }
    .bad{ color: var(--bad); }
    .mutedCell{ color: var(--muted); }

    .donateBar{
      margin-top: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: 0.95rem;
      text-align: center;
    }

    #splash{
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #splash h1{ font-size: 2rem; margin: 0 0 1rem; }
    #splash img{ width: 260px; height: 260px; }

    footer{
      margin-top: 18px;
      text-align: center;
      color: #888;
      font-size: 0.85rem;
    }
    .footerRow{
      display: inline-flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* Settings panel */
    .settingsPanel{
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.32);
      z-index: 50;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .settingsCard{
      width: min(560px, 100%);
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.18);
      overflow: hidden;
    }
    .settingsHead{
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .settingsHead h3{ margin: 0; font-size: 1.05rem; font-weight: 900; }
    .settingsBody{
      padding: 14px 16px 16px;
      display: grid;
      gap: 12px;
    }
    .row{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .row label{ font-weight: 900; }
    .row .hint{
      width: 100%;
      color: var(--muted);
      font-size: 0.9rem;
      margin-top: -6px;
    }
    select, input[type="checkbox"]{ cursor: pointer; }
    select{
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 800;
      background: #fff;
    }

    /* How it works modal */
    .howModal{
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.32);
      z-index: 55;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    /* ========= Plus modal styles (kept compatible with Index) ========= */
    .modalOverlay{
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      z-index: 60;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .modal{
      width: min(560px, 100%);
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.18);
      overflow: hidden;
    }
    .modalHead{
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .modalHead h3{ margin: 0; font-size: 1.05rem; font-weight: 900; }
    .closeBtn{
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 12px;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 900;
    }
    .closeBtn:hover{ background: #fafafa; }
    .modalBody{
      padding: 14px 16px 16px;
      color: #374151;
    }
    .modalActions{
      margin-top: 12px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
  </style>
</head>

<body>
  <!-- Splash -->
  <div id="splash" aria-label="Loading screen">
    <h1><span lang="de">Welcher Artikel?</span></h1>
    <img src="icon.png" alt="DeutschBuddy Logo" />
  </div>

  <!-- Top bar (no Settings here anymore) -->
  <header>
    <div class="topbar">
      <div class="brand">
        <a href="index.html" aria-label="Go to home">
          <img src="icon.png" alt="DeutschBuddy Logo" />
          <div class="titles">
            <h1>DeutschBuddy</h1>
            <p><span lang="de">Welcher Artikel?</span> ‚Ä¢ der/die/das</p>
          </div>
        </a>
      </div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <a class="btn" href="index.html" aria-label="Go to home">Home</a>
        <a class="btn" href="artikelregeln.html" aria-label="Open rules">Rules</a>
      </div>
    </div>
  </header>

  <div class="wrap">
    <section class="hero" aria-label="Game intro">
      <div class="heroTitleRow">
        <h2 class="heroTitle">Choose the correct article.</h2>
        <div class="heroActions">
          <button class="iconBtn" id="howBtn" type="button" aria-label="How it works">How it works</button>
          <button class="iconBtn" id="settingsBtn" type="button" aria-label="Open settings">Settings</button>
        </div>
      </div>

      <p class="heroSub">
        Tap <span lang="de">der</span>, <span lang="de">die</span> or <span lang="de">das</span>.
        Instant feedback ‚Äî the next word loads automatically (<span id="delayLabel">1</span> second<span id="delayPlural">s</span>).
      </p>
    </section>

    <div class="grid">
      <!-- LEFT: Quiz -->
      <section class="card" aria-label="Quiz">
        <div class="cardHead">
          <div class="cardHeadLeft">
            <p class="title">Game</p>
            <p class="subtitle">Fast practice ‚Ä¢ 1‚Äì3 minutes</p>
          </div>

          <div class="hud" aria-label="Progress">
            <div class="pill" title="Score"><span>‚≠ê</span><div id="hudScore">0</div></div>
            <div class="pill" title="Streak"><span>üî•</span><div id="hudStreak">0</div></div>
            <div class="pill" title="Accuracy"><span>üìä</span><div id="hudAcc">0%</div></div>
            <div class="pill" title="Mistakes (stop rule)"><span>‚ùå</span><div id="hudMistakes">0</div></div>
          </div>
        </div>

        <div class="content">
          <!-- Setup -->
          <div class="setup" id="setup">
            <div class="banner" id="endBanner" style="display:none;">
              Game finished.
              <small id="endBannerSub">You reached the mistake limit.</small>
            </div>

            <div class="levelRow" aria-label="Level selection">
              <div class="levelLabel">Level:</div>

              <button class="levelBtn" type="button" id="lvlA1" aria-pressed="true" aria-label="Select A1">A1</button>

              <button class="levelBtn" type="button" id="lvlA2" aria-pressed="false" aria-label="Select A2 (includes A1)">
                A2 <span class="includeTag" title="Includes A1">A1+</span>
              </button>

              <!-- Locked levels: use same selector as Index script -->
              <div class="levelBtn gameCard locked" role="button" tabindex="0" data-plus="B1 level" aria-label="B1 Plus (locked)">
                B1 <span class="plusTag">Plus</span>
              </div>

              <div class="levelBtn gameCard locked" role="button" tabindex="0" data-plus="B2 level" aria-label="B2 Plus (locked)">
                B2 <span class="plusTag">Plus</span>
              </div>
            </div>

            <div class="miniNote" id="levelHint">A2 automatically includes A1 words for more variety.</div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
              <button class="btn btnStart" id="startBtn" type="button">Start</button>

              <!-- Plus-only feature entry point -->
              <div class="btn gameCard locked" role="button" tabindex="0" data-plus="Fehler √ºben (Practice mistakes)">
                Practice mistakes <span class="plusTag">Plus</span>
              </div>
            </div>

            <div style="height:1px; background: var(--border); margin: 14px 0;"></div>

            <div class="miniNote" id="deviceStatsLine">Loading your device stats‚Ä¶</div>
          </div>

          <!-- Playing UI -->
          <div id="playArea" style="display:none;">
            <div class="word" id="word">Loading words‚Ä¶</div>
            <div class="metaLine" id="metaLine"></div>

            <div class="options" id="options" aria-label="Answer options"></div>

            <div class="result" id="result" aria-live="polite"></div>

            <div class="extra" id="extra" aria-live="polite"></div>

            <div class="countdownRow">
              <div id="countdown"></div>
              <button id="pauseBtn" class="btn btnSmall" type="button">Pause</button>
              <button id="resetBtn" class="btn btnSmall btnResetSmall" type="button" title="Reset session">Reset</button>
            </div>
          </div>
        </div>

        <!-- Answers -->
        <details class="answersDetails" id="answersDetails">
          <summary>
            <span>Answers (Click for details) ‚ñæ</span>
            <span style="color:var(--muted); font-weight:900;" id="answersSummary">0 items</span>
          </summary>
          <div class="historyWrap">
            <table aria-label="Answers table">
              <thead>
                <tr>
                  <th>Your answer</th>
                  <th class="status">Result</th>
                  <th>Correct</th>
                </tr>
              </thead>
              <tbody id="historyBody"></tbody>
            </table>
          </div>
        </details>
      </section>

      <!-- RIGHT: Device stats -->
      <aside class="card" aria-label="Device stats">
        <div class="cardHead">
          <div class="cardHeadLeft">
            <p class="title">Stats</p>
            <p class="subtitle">Device progress (local)</p>
          </div>
        </div>

        <div class="content" style="display:grid; gap:12px;">
          <div class="pill" style="justify-content:space-between;">
            <span>Best score (device)</span>
            <strong id="bestScore">0</strong>
          </div>
          <div class="pill" style="justify-content:space-between;">
            <span>Best streak (device)</span>
            <strong id="bestStreak">0</strong>
          </div>
          <div class="pill" style="justify-content:space-between;">
            <span>Daily streak</span>
            <strong id="dailyStreak">0</strong>
          </div>

          <div style="height:1px; background: var(--border);"></div>

          <div style="color:var(--muted); font-size:0.95rem;">
            Default: <strong>1s</strong> auto-advance and <strong>5 mistakes</strong> stop rule. You can change both in Settings.
          </div>
        </div>
      </aside>
    </div>

    <!-- Support -->
    <div class="donateBar">
      <span>Enjoying the quiz? Support the project so new updates can happen. Thank you!</span>
      <a class="btn btnPrimary btnSmall"
         href="https://www.paypal.com/donate/?hosted_button_id=5HNZSM7VZTNA6"
         target="_blank" rel="noopener noreferrer">
        Support / Donate
      </a>
    </div>

    <footer>
      <div class="footerRow">
        <span>DeutschBuddy ‚Ä¢ Ver. 1.0</span>
        <a class="btn btnSmall" href="ueber-mich.html" aria-label="About">About</a>
      </div>
    </footer>
  </div>

  <!-- Settings panel -->
  <div class="settingsPanel" id="settingsPanel" aria-hidden="true">
    <div class="settingsCard" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <div class="settingsHead">
        <h3 id="settingsTitle">Settings</h3>
        <button class="closeBtn" id="closeSettings" aria-label="Close settings">‚úï</button>
      </div>

      <div class="settingsBody">
        <div class="row">
          <label for="showTranslation">Show translation</label>
          <input id="showTranslation" type="checkbox" />
        </div>

        <div class="row">
          <label for="showPlural">Show plural</label>
          <input id="showPlural" type="checkbox" />
        </div>

        <div class="row">
          <label for="autoAdvance">Auto-advance</label>
          <input id="autoAdvance" type="checkbox" />
          <div class="hint">Loads the next word automatically after the delay.</div>
        </div>

        <div class="row">
          <label for="autoSeconds">Auto-advance delay</label>
          <select id="autoSeconds">
            <option value="1">1 second (default)</option>
            <option value="3">3 seconds</option>
          </select>
        </div>

        <div class="row">
          <label for="maxErrors">Stop after mistakes</label>
          <select id="maxErrors">
            <option value="5">5 mistakes (default)</option>
            <option value="10">10 mistakes</option>
            <option value="0">Infinite</option>
          </select>
          <div class="hint">When enabled, the session ends when you reach the limit.</div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-top:6px;">
          <button class="btn btnResetSmall" id="resetDeviceStats" type="button" title="Clear local stats">Reset device stats</button>
          <button class="btn btnPrimary" id="saveSettings" type="button">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- How it works modal -->
  <div class="howModal" id="howModal" aria-hidden="true">
    <div class="settingsCard" role="dialog" aria-modal="true" aria-labelledby="howTitle">
      <div class="settingsHead">
        <h3 id="howTitle">How it works</h3>
        <button class="closeBtn" id="closeHow" aria-label="Close how it works">‚úï</button>
      </div>
      <div class="settingsBody">
        <div style="color:var(--muted); font-weight:800;">
          Short, snackable practice for <span lang="de">der/die/das</span>.
        </div>
        <ul style="margin:0; padding-left:18px; color:#374151;">
          <li>You‚Äôll see a German noun ‚Äî tap the correct article.</li>
          <li>Enable <strong>translation</strong> or <strong>plural</strong> in Settings.</li>
          <li>Default stop rule is <strong>5 mistakes</strong> (change to infinite if you want).</li>
          <li>Your progress is stored locally on this device (no account).</li>
        </ul>
        <div style="display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
          <a class="btn" href="artikelregeln.html">Read the rules</a>
          <button class="btn btnPrimary" id="gotItHow" type="button">Got it</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Plus modal (EXACT CODE FROM INDEX) -->
  <!-- Plus modal -->
  <div class="modalOverlay" id="plusModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="plusTitle">
      <div class="modalHead">
        <div>
          <h3 id="plusTitle">DeutschBuddy Plus ‚Äî Coming soon</h3>
        </div>
        <button class="closeBtn" id="closeModal" aria-label="Close">‚úï</button>
      </div>
      <div class="modalBody">
        <p id="plusText">
          This game is part of <strong>DeutschBuddy Plus</strong> and will be available soon.
          Want early access and updates?
        </p>
        <div class="modalActions">
          <a class="btn btnPrimary" id="waitlistBtn"
             href="https://docs.google.com/forms/d/e/1FAIpQLSd7aZ8okTdi2sr08p8l8HZ2r6oH09BsF3L_mJQtSc8q0nFRdw/viewform?usp=header"
             target="_blank" rel="noopener noreferrer">
            Join the waitlist
          </a>
          <button class="btn" id="okBtn" type="button">Not now</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // Data source (TSV)
    // =========================
    const dataUrl =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vTLMG3zUFzaLSA82QS7T4E8IAHiung0H2LYRU8hoi_svBol2OoFWmTFBhGVhCPxK2xGtADv1sM9guDr/pub?output=tsv";

    // =========================
    // Local storage keys
    // =========================
    const LS_PREFS = "db_wa_prefs_v3";
    const LS_STATS = "db_wa_stats_v3";
    const LS_MISTAKES = "db_wa_mistakes_v1";

    // =========================
    // State
    // =========================
    let rawData = [];
    let pool = [];
    let currentIndex = 0;

    let correct = 0;
    let wrong = 0;
    let streak = 0;
    let score = 0;

    let selectedLevel = "A1";
    let showTranslation = false;
    let showPlural = true;

    let autoEnabled = true;
    let autoSeconds = 1;     // default 1 second, options: 1 or 3

    let maxErrors = 5;       // default 5, options: 5/10/Infinite(0)

    let countdownTimer = null;
    let remaining = 0;
    let inputLocked = false;

    // =========================
    // Helpers
    // =========================
    function safeText(v){ return (v ?? "").toString().trim(); }
    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function shuffle(array){
      for (let i = array.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function todayISO(){
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    }

    function parseLevel(s){
      const v = safeText(s).toUpperCase();
      if (v === "A1" || v === "A2" || v === "B1" || v === "B2") return v;
      return "";
    }

    function getPrefs(){
      try{ return JSON.parse(localStorage.getItem(LS_PREFS) || "{}"); }
      catch{ return {}; }
    }
    function setPrefs(obj){ localStorage.setItem(LS_PREFS, JSON.stringify(obj)); }

    function getStats(){
      try{ return JSON.parse(localStorage.getItem(LS_STATS) || "{}"); }
      catch{ return {}; }
    }
    function setStats(obj){ localStorage.setItem(LS_STATS, JSON.stringify(obj)); }

    function getMistakes(){
      try{ return JSON.parse(localStorage.getItem(LS_MISTAKES) || "{}"); }
      catch{ return {}; }
    }
    function setMistakes(obj){ localStorage.setItem(LS_MISTAKES, JSON.stringify(obj)); }

    function updateDailyStreak(){
      const stats = getStats();
      const today = todayISO();
      const last = stats.lastPlayDate || "";
      if (!stats.dailyStreak) stats.dailyStreak = 0;

      if (last === today){
        setStats(stats);
        return;
      }

      const d = new Date();
      d.setDate(d.getDate() - 1);
      const y = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;

      stats.dailyStreak = (last === y) ? (stats.dailyStreak + 1) : 1;
      stats.lastPlayDate = today;
      setStats(stats);
    }

    // =========================
    // UI refs
    // =========================
    const setupEl = document.getElementById("setup");
    const playAreaEl = document.getElementById("playArea");

    const lvlA1Btn = document.getElementById("lvlA1");
    const lvlA2Btn = document.getElementById("lvlA2");
    const levelHint = document.getElementById("levelHint");
    const startBtn = document.getElementById("startBtn");

    const endBanner = document.getElementById("endBanner");
    const endBannerSub = document.getElementById("endBannerSub");

    const wordEl = document.getElementById("word");
    const metaLineEl = document.getElementById("metaLine");
    const optionsDiv = document.getElementById("options");
    const resultDiv = document.getElementById("result");
    const extraEl = document.getElementById("extra");
    const countdownEl = document.getElementById("countdown");
    const pauseBtn = document.getElementById("pauseBtn");
    const resetBtn = document.getElementById("resetBtn");

    const hudScoreEl = document.getElementById("hudScore");
    const hudStreakEl = document.getElementById("hudStreak");
    const hudAccEl = document.getElementById("hudAcc");
    const hudMistakesEl = document.getElementById("hudMistakes");

    const historyBody = document.getElementById("historyBody");
    const answersSummary = document.getElementById("answersSummary");

    const bestScoreEl = document.getElementById("bestScore");
    const bestStreakEl = document.getElementById("bestStreak");
    const dailyStreakEl = document.getElementById("dailyStreak");
    const deviceStatsLine = document.getElementById("deviceStatsLine");

    // hero delay label
    const delayLabel = document.getElementById("delayLabel");
    const delayPlural = document.getElementById("delayPlural");

    // Settings UI
    const settingsBtn = document.getElementById("settingsBtn");
    const settingsPanel = document.getElementById("settingsPanel");
    const closeSettings = document.getElementById("closeSettings");
    const saveSettingsBtn = document.getElementById("saveSettings");
    const resetDeviceStatsBtn = document.getElementById("resetDeviceStats");

    const showTranslationCb = document.getElementById("showTranslation");
    const showPluralCb = document.getElementById("showPlural");
    const autoAdvanceCb = document.getElementById("autoAdvance");
    const autoSecondsSel = document.getElementById("autoSeconds");
    const maxErrorsSel = document.getElementById("maxErrors");

    // How it works UI
    const howBtn = document.getElementById("howBtn");
    const howModal = document.getElementById("howModal");
    const closeHow = document.getElementById("closeHow");
    const gotItHow = document.getElementById("gotItHow");

    // =========================
    // Prefs init
    // =========================
    function loadPrefsToState(){
      const p = getPrefs();

      selectedLevel = (p.level === "A2") ? "A2" : "A1";
      showTranslation = !!p.showTranslation;
      showPlural = (p.showPlural !== undefined) ? !!p.showPlural : true;

      autoEnabled = (p.autoEnabled !== undefined) ? !!p.autoEnabled : true;
      autoSeconds = (p.autoSeconds === 3) ? 3 : 1;

      // default 5; allow 10; allow infinite (0)
      const me = parseInt(p.maxErrors ?? 5, 10);
      maxErrors = (me === 0 || me === 10 || me === 5) ? me : 5;
    }

    function saveStateToPrefs(){
      setPrefs({
        level: selectedLevel,
        showTranslation,
        showPlural,
        autoEnabled,
        autoSeconds,
        maxErrors
      });
    }

    function syncPrefsToSettingsUI(){
      showTranslationCb.checked = showTranslation;
      showPluralCb.checked = showPlural;
      autoAdvanceCb.checked = autoEnabled;
      autoSecondsSel.value = String(autoSeconds);
      maxErrorsSel.value = String(maxErrors);
    }

    function syncDelayLabel(){
      delayLabel.textContent = String(autoSeconds);
      delayPlural.textContent = (autoSeconds === 1) ? "" : "s";
    }

    function syncLevelButtons(){
      lvlA1Btn.setAttribute("aria-pressed", selectedLevel === "A1" ? "true" : "false");
      lvlA2Btn.setAttribute("aria-pressed", selectedLevel === "A2" ? "true" : "false");
      levelHint.textContent = (selectedLevel === "A2")
        ? "A2 automatically includes A1 words for more variety."
        : "A1 uses beginner words only.";
    }

    // =========================
    // HUD + device stats
    // =========================
    function updateHud(){
      hudScoreEl.textContent = String(score);
      hudStreakEl.textContent = String(streak);

      const total = correct + wrong;
      const acc = total > 0 ? Math.round((correct / total) * 100) : 0;
      hudAccEl.textContent = `${acc}%`;

      if (maxErrors > 0) hudMistakesEl.textContent = `${wrong}/${maxErrors}`;
      else hudMistakesEl.textContent = `${wrong}`;
    }

    function updateDeviceStatsUI(){
      const stats = getStats();
      bestScoreEl.textContent = String(stats.bestScore || 0);
      bestStreakEl.textContent = String(stats.bestStreak || 0);
      dailyStreakEl.textContent = String(stats.dailyStreak || 0);

      const totalAnswered = stats.totalAnswered || 0;
      const totalCorrect = stats.totalCorrect || 0;
      const lifetimeAcc = totalAnswered > 0 ? Math.round((totalCorrect / totalAnswered) * 100) : 0;

      deviceStatsLine.innerHTML =
        `On this device: <strong>${stats.sessions || 0}</strong> sessions ‚Ä¢ ` +
        `<strong>${lifetimeAcc}%</strong> lifetime accuracy ‚Ä¢ ` +
        `<strong>${totalAnswered}</strong> answers total.`;
    }

    // =========================
    // Data loading
    // =========================
    async function loadData(){
      try{
        const res = await fetch(dataUrl + "&t=" + Date.now());
        if (!res.ok) throw new Error("HTTP " + res.status);
        const text = await res.text();

        const lines = text.trim().split("\n");
        const header = lines[0].split("\t").map(safeText);
        const dataLines = lines.slice(1);

        const idx = {};
        header.forEach((h, i) => idx[h.toLowerCase()] = i);

        const iArticle = (idx["article"] ?? 0);
        const iWord = (idx["word"] ?? 1);
        const iPlural = (idx["plural"] ?? 2);
        const iExample = (idx["example"] ?? 3);
        const iTrans = (idx["italian"] ?? idx["translation"] ?? 4);
        const iLevel = (idx["level"] ?? (header.length - 1));

        rawData = dataLines
          .map(line => line.split("\t"))
          .map(cols => {
            const article = safeText(cols[iArticle]);
            const word = safeText(cols[iWord]);
            if (!word || !article) return null;

            const plural = safeText(cols[iPlural]);
            const example = safeText(cols[iExample]);
            const translation = safeText(cols[iTrans]);
            const level = parseLevel(cols[iLevel]);

            const key = `${article}|${word}`.toLowerCase();
            return { key, level, article, word, plural, example, translation };
          })
          .filter(Boolean);

        if (!rawData.length) throw new Error("No valid rows.");
      }catch(e){
        wordEl.textContent = "Loading failed üòï";
        resultDiv.textContent = "Please check your connection and reload the page.";
        console.error(e);
      }
    }

    function buildPool(){
      if (selectedLevel === "A2"){
        pool = rawData.filter(it => it.level === "A1" || it.level === "A2" || !it.level);
      } else {
        pool = rawData.filter(it => it.level === "A1" || !it.level);
      }
      shuffle(pool);
      currentIndex = 0;
    }

    // =========================
    // Countdown
    // =========================
    function setCountdownText(text){ countdownEl.textContent = text || ""; }

    function clearCountdown(keepRemaining=false){
      if (countdownTimer){
        clearInterval(countdownTimer);
        countdownTimer = null;
      }
      if (!keepRemaining) remaining = 0;
      if (!keepRemaining) setCountdownText("");
    }

    function startCountdown(seconds){
      clearCountdown(false);
      remaining = seconds;

      if (!autoEnabled){
        setCountdownText("Paused");
        return;
      }

      // If 1 second, keep it lightweight
      if (remaining <= 1){
        setCountdownText("Next‚Ä¶");
      } else {
        setCountdownText(`Next word in ${remaining}‚Ä¶`);
      }

      countdownTimer = setInterval(() => {
        if (!autoEnabled){
          clearCountdown(true);
          setCountdownText("Paused");
          return;
        }

        remaining -= 1;

        if (remaining > 0){
          if (remaining <= 1) setCountdownText("Next‚Ä¶");
          else setCountdownText(`Next word in ${remaining}‚Ä¶`);
        } else {
          clearCountdown(false);
          nextQuestion();
        }
      }, 1000);
    }

    // =========================
    // History + extra
    // =========================
    function updateAnswersSummary(){
      const n = historyBody.children.length;
      answersSummary.textContent = `${n} item${n === 1 ? "" : "s"}`;
    }

    function addHistoryRow(chosenArticle, word, isCorrect, correctArticle){
      const tr = document.createElement("tr");

      const tdChosen = document.createElement("td");
      tdChosen.textContent = `${chosenArticle} ${word}`;

      const tdStatus = document.createElement("td");
      tdStatus.className = "status " + (isCorrect ? "ok" : "bad");
      tdStatus.textContent = isCorrect ? "‚úì" : "‚úó";

      const tdRight = document.createElement("td");
      if (isCorrect){
        tdRight.textContent = "‚Äî";
        tdRight.className = "mutedCell";
      } else {
        tdRight.textContent = `${correctArticle} ${word}`;
      }

      tr.appendChild(tdChosen);
      tr.appendChild(tdStatus);
      tr.appendChild(tdRight);

      historyBody.prepend(tr);

      const MAX_ROWS = 50;
      while (historyBody.children.length > MAX_ROWS){
        historyBody.removeChild(historyBody.lastChild);
      }

      updateAnswersSummary();
    }

    function renderExtra(item){
      extraEl.innerHTML = "";

      const rows = [];
      if (showPlural) rows.push(["Plural:", item.plural]);
      rows.push(["Example:", item.example]);

      if (!rows.length){
        extraEl.textContent = "‚Äî";
        return;
      }

      rows.forEach(([label, value]) => {
        const line = document.createElement("div");
        const strong = document.createElement("strong");
        strong.textContent = label + " ";
        line.appendChild(strong);
        line.appendChild(document.createTextNode(value || "‚Äî"));
        extraEl.appendChild(line);
      });
    }

    // =========================
    // Mistakes store (saved locally; practice mode is Plus-only)
    // =========================
    function recordMistake(item){
      const mistakes = getMistakes();
      const entry = mistakes[item.key] || { word: item.word, article: item.article, level: item.level, wrongCount: 0, lastWrongAt: 0 };
      entry.wrongCount += 1;
      entry.lastWrongAt = Date.now();
      mistakes[item.key] = entry;
      setMistakes(mistakes);
    }

    // =========================
    // Scoring
    // =========================
    function awardCorrect(){
      const bonus = clamp(streak, 0, 6);
      score += (10 + bonus);
    }
    function penalizeWrong(){ score -= 5; }

    // =========================
    // Session finalize
    // =========================
    let sessionBestStreak = 0;

    function finalizeSessionToDeviceStats(){
      const stats = getStats();
      stats.sessions = (stats.sessions || 0) + 1;

      stats.totalAnswered = (stats.totalAnswered || 0) + (correct + wrong);
      stats.totalCorrect = (stats.totalCorrect || 0) + correct;

      stats.bestScore = Math.max(stats.bestScore || 0, score);
      stats.bestStreak = Math.max(stats.bestStreak || 0, sessionBestStreak);

      setStats(stats);
      updateDailyStreak();
      updateDeviceStatsUI();
    }

    function showFinishedBanner(reason){
      endBanner.style.display = "";
      endBannerSub.textContent = reason;
    }

    function showGameOver(){
      inputLocked = true;
      clearCountdown(false);

      Array.from(optionsDiv.querySelectorAll("button")).forEach(b => b.disabled = true);

      resultDiv.textContent = "üõë Game over ‚Äî mistake limit reached.";
      extraEl.innerHTML = `
        <div><strong>Session summary</strong></div>
        <div>Score: <strong>${score}</strong> ‚Ä¢ Correct: <strong>${correct}</strong> ‚Ä¢ Wrong: <strong>${wrong}</strong></div>
        <div>Best streak this session: <strong>${sessionBestStreak}</strong></div>
      `;

      setCountdownText("");

      finalizeSessionToDeviceStats();

      // Bring user back to setup + show an explicit finished message
      showFinishedBanner("You reached the maximum number of mistakes.");
      setupEl.style.display = "";
      playAreaEl.style.display = "none";
      startBtn.textContent = "Retry";
      startBtn.focus({ preventScroll: true });
    }

    // =========================
    // Question rendering
    // =========================
    function renderMetaLine(item){
      const parts = [];
      if (item.level) parts.push(`Level: ${item.level}`);
      if (showTranslation){
        const t = item.translation ? item.translation : "‚Äî";
        parts.push(`Translation: ${t}`);
      }
      metaLineEl.textContent = parts.join("  ‚Ä¢  ");
    }

    function loadQuestion(){
      if (!pool.length){
        wordEl.textContent = "No words available.";
        resultDiv.textContent = "Try a different level.";
        metaLineEl.textContent = "";
        return;
      }

      inputLocked = false;
      clearCountdown(false);

      const item = pool[currentIndex];
      wordEl.textContent = item.word || "‚Äî";
      renderMetaLine(item);

      resultDiv.textContent = "";
      extraEl.textContent = "";
      setCountdownText("");

      optionsDiv.innerHTML = "";
      ["der","die","das"].forEach(opt => {
        const btn = document.createElement("button");
        btn.textContent = opt;
        btn.setAttribute("data-article", opt);
        btn.type = "button";
        btn.addEventListener("click", () => handleAnswer(opt, item));
        optionsDiv.appendChild(btn);
      });
    }

    function nextQuestion(){
      if (!pool.length) return;
      currentIndex = (currentIndex + 1) % pool.length;
      loadQuestion();
    }

    function handleAnswer(opt, item){
      if (inputLocked) return;
      inputLocked = true;

      Array.from(optionsDiv.querySelectorAll("button")).forEach(b => b.disabled = true);

      const isCorrect = (opt === item.article);

      if (isCorrect){
        correct += 1;
        streak += 1;
        sessionBestStreak = Math.max(sessionBestStreak, streak);
        awardCorrect();
        resultDiv.textContent = "‚úÖ Correct!";
      } else {
        wrong += 1;
        streak = 0;
        penalizeWrong();
        recordMistake(item);
        resultDiv.textContent = `‚ùå Wrong ‚Äî correct is "${item.article}"`;
      }

      renderExtra(item);
      addHistoryRow(opt, item.word, isCorrect, item.article);
      updateHud();
      updateDeviceStatsUI();

      // Stop rule (if infinite, maxErrors = 0)
      if (maxErrors > 0 && wrong >= maxErrors){
        showGameOver();
        return;
      }

      if (autoEnabled){
        startCountdown(autoSeconds);
      } else {
        setCountdownText("Paused");
      }
    }

    // =========================
    // Start / Reset
    // =========================
    function resetSessionUIOnly(){
      correct = 0;
      wrong = 0;
      streak = 0;
      score = 0;
      sessionBestStreak = 0;

      historyBody.innerHTML = "";
      updateAnswersSummary();

      resultDiv.textContent = "";
      extraEl.textContent = "";
      clearCountdown(false);

      updateHud();
    }

    async function startGame(){
      // hide finished banner when starting again
      endBanner.style.display = "none";

      if (!rawData.length){
        await loadData();
      }

      buildPool();

      if (!pool.length){
        setupEl.style.display = "";
        playAreaEl.style.display = "none";
        wordEl.textContent = "No words for this level yet.";
        resultDiv.textContent = "Try A1, or add more items in your sheet.";
        metaLineEl.textContent = "";
        return;
      }

      resetSessionUIOnly();

      setupEl.style.display = "none";
      playAreaEl.style.display = "";
      pauseBtn.textContent = autoEnabled ? "Pause" : "Resume";

      loadQuestion();
    }

    // =========================
    // Level selection (no Mix)
    // =========================
    lvlA1Btn.addEventListener("click", () => {
      selectedLevel = "A1";
      syncLevelButtons();
      saveStateToPrefs();
    });
    lvlA2Btn.addEventListener("click", () => {
      selectedLevel = "A2";
      syncLevelButtons();
      saveStateToPrefs();
    });

    startBtn.addEventListener("click", startGame);

    resetBtn.addEventListener("click", () => {
      clearCountdown(false);
      setupEl.style.display = "";
      playAreaEl.style.display = "none";
      startBtn.textContent = "Start";
      resetSessionUIOnly();
      if (pool.length) shuffle(pool);
    });

    pauseBtn.addEventListener("click", () => {
      autoEnabled = !autoEnabled;
      pauseBtn.textContent = autoEnabled ? "Pause" : "Resume";
      saveStateToPrefs();

      if (!autoEnabled){
        if (countdownTimer){
          clearInterval(countdownTimer);
          countdownTimer = null;
        }
        setCountdownText("Paused");
        return;
      }

      if (remaining > 0){
        startCountdown(remaining);
      } else {
        setCountdownText("");
      }
    });

    // =========================
    // Settings panel
    // =========================
    function openSettings(){
      syncPrefsToSettingsUI();
      settingsPanel.style.display = "flex";
      settingsPanel.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
      closeSettings.focus({ preventScroll: true });
    }

    function closeSettingsPanel(){
      settingsPanel.style.display = "none";
      settingsPanel.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    }

    settingsBtn.addEventListener("click", openSettings);
    closeSettings.addEventListener("click", closeSettingsPanel);
    settingsPanel.addEventListener("click", (e) => {
      if (e.target === settingsPanel) closeSettingsPanel();
    });

    saveSettingsBtn.addEventListener("click", () => {
      showTranslation = showTranslationCb.checked;
      showPlural = showPluralCb.checked;
      autoEnabled = autoAdvanceCb.checked;

      autoSeconds = (parseInt(autoSecondsSel.value, 10) === 3) ? 3 : 1;

      const me = parseInt(maxErrorsSel.value, 10);
      maxErrors = (me === 0 || me === 10 || me === 5) ? me : 5;

      saveStateToPrefs();
      syncDelayLabel();
      updateHud();

      // update meta line immediately if playing
      if (playAreaEl.style.display !== "none" && pool.length){
        renderMetaLine(pool[currentIndex]);
      }

      closeSettingsPanel();
    });

    resetDeviceStatsBtn.addEventListener("click", () => {
      const ok = confirm("This will clear your local device stats for this game (best score/streak, daily streak). Continue?");
      if (!ok) return;
      localStorage.removeItem(LS_STATS);
      updateDeviceStatsUI();
    });

    // =========================
    // How it works modal
    // =========================
    function openHowModal(){
      howModal.style.display = "flex";
      howModal.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
      closeHow.focus({ preventScroll: true });
    }
    function closeHowModal(){
      howModal.style.display = "none";
      howModal.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    }

    howBtn.addEventListener("click", openHowModal);
    closeHow.addEventListener("click", closeHowModal);
    gotItHow.addEventListener("click", closeHowModal);
    howModal.addEventListener("click", (e) => {
      if (e.target === howModal) closeHowModal();
    });

    // Global ESC
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && settingsPanel.style.display === "flex") closeSettingsPanel();
      if (e.key === "Escape" && howModal.style.display === "flex") closeHowModal();
    });

    // =========================
    // Init
    // =========================
    (function init(){
      loadPrefsToState();
      syncLevelButtons();
      syncDelayLabel();
      updateHud();
      updateDeviceStatsUI();
      syncPrefsToSettingsUI();
      updateAnswersSummary();

      loadData();

      setTimeout(() => {
        const splash = document.getElementById("splash");
        if (splash) splash.style.display = "none";
      }, 900);
    })();
  </script>

  <!-- Plus modal script (EXACT CODE FROM INDEX) -->
  <script>
    const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSd7aZ8okTdi2sr08p8l8HZ2r6oH09BsF3L_mJQtSc8q0nFRdw/viewform?usp=header";

    const modal = document.getElementById("plusModal");
    const closeModalBtn = document.getElementById("closeModal");
    const okBtn = document.getElementById("okBtn");
    const plusText = document.getElementById("plusText");
    const waitlistBtn = document.getElementById("waitlistBtn");

    function openModal(moduleName){
      plusText.innerHTML =
        `The <strong>${moduleName}</strong> is part of <strong>DeutschBuddy Plus</strong> and will be available soon.<br>` +
        `Want early access and updates?`;
      waitlistBtn.href = formUrl; // keep it simple (no prefill)
      modal.style.display = "flex";
      modal.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    }

    function closeModal(){
      modal.style.display = "none";
      modal.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    }

    // Open modal on locked cards
    document.querySelectorAll(".gameCard.locked").forEach(card => {
      const name = card.getAttribute("data-plus") || "This game";
      card.addEventListener("click", () => openModal(name));
      card.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          openModal(name);
        }
      });
    });

    closeModalBtn.addEventListener("click", closeModal);
    okBtn.addEventListener("click", closeModal);

    modal.addEventListener("click", (e) => {
      if (e.target === modal) closeModal();
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && modal.style.display === "flex") closeModal();
    });
  </script>
</body>
</html>



